---
title: "Tests of fitSHOW method"
author: "Feiyu Zhu"
date: 
link-citations: true
output: 
  pdf_document:
    number_sections: true
    fig_caption: true
vignette: >
  %\VignetteIndexEntry{test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = '80%', fig.align='center')
suppressMessages(require(realPSD))
suppressMessages(require(tidyverse))
```

# Check the empirical PSD matches up with the analytic one.

First we list some physical constants which will be used to generate a single random dataset.

```{r, constants}
# ---------- SHO model parameters ----------
Time  <- 5                   # Total time, second
fs <- 1e7                    # Sampling frequency, Hz
f0 <- 33553                  # Resonance frequency, Hz
Q <-  1                      # Quality factor, unitless
k  <- 0.172                  # Cantilever stiffness, N/m
Kb <- 1.381e-23              # Boltzmann's constant, (m2*kg)/(s2*K)
Temp <- 298                  # Temperature, K
Const <- 1e30                # unit conversion, 1 m2 = 1e30 fm2
Aw <- 19000/Const            # White noise psd, m2/Hz 
```

Then we set the frequency domain as $f_0 \pm f_0/\sqrt{2}$, i.e.,

```{r, freq_domain}
f_lb <- f0 - f0/sqrt(2) # frequency lower bound
f_ub <- f0 + f0/sqrt(2) # frequency upper bound
fseq <- seq(from = f_lb, to = f_ub, by = 1/Time) # frequency domain, Hz
nf <- length(fseq) # number of frequencies
```

The analytic PSD can be calculated exactly by using `realPSD::psdSHO()`.

```{r, analytic_psd}
# analytic psd values, unit fm2/Hz
psd <- psdSHO(fseq, f0, Q, k, Kb, Temp, unit_conversion = FALSE) + Aw
```

By the result of Theorem 1, we can simulate the periodogram values and smooth them by binning with bin size to be 100.

```{r, sim_periodogram}
# simulate exponential random variables
sim_exp <- rexp(nf, rate = 1)
# empirical psd (periodogram values)
Y <- sim_exp * psd * fs
# smoothed empirical psd (by binning)
bin_size <- 100
fbar <- binning(fseq, bin_size = bin_size)
Ybar <- binning(Y, bin_size = bin_size)
```

Finally we can plot the smoothed periodogram and superimpose the analytic PSD in one figure (on log-log scale).

```{r, psd, fig.cap = "Empirical smoothed periodogram v.s. analytic PSD."}
plot(x = fbar, y = Ybar/fs, 
  xlab = "frequency (Hz)", ylab = expression(paste("PSD (", fm^2/Hz, ")")),
  type = "l", lwd = 0.3, log = "xy")
lines(x = fbar, psdSHO(fbar, f0, Q, k, Kb, Temp, FALSE), col = "red")
legend("bottomleft",
  legend = c("Empirical", "Analytic"), 
  col = c("black", "red"),
  bty = "n", # no box around the legend
  cex = 1, # size of the text,
  lwd = 1
)
```

As we can see from Figure \ref{fig:psd}, the simulated periodogram matches up with the analytic PSD, which ensures that our simulation of the periodogram by using Theorem 1 does its job.

# Check the MLE estimation/optimization is correct.


